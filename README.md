# Claude Code External Memory System

Claude Code に外部永続メモリを追加し、過去の学びを自動的に蓄積・検索・再利用するシステム。

## 概要

Claude Code は継続学習（重み更新）ができないため、代替として外部メモリに「学び」を保存し、次回以降に検索・参照する仕組みを提供する。

## ディレクトリ構成

```
~/.claude/
├── system/
│   └── claude_code_memory.md   # システムプロンプト（メモリ運用ルール）
├── db/
│   └── memos.sqlite            # メモのデータベース
├── bin/
│   ├── cc                      # Claude Code ラッパースクリプト
│   └── daily-report.sh         # 日報生成スクリプト
├── memory/
│   ├── daily/                  # 日報ファイル（YYYY-MM-DD.md）
│   └── logs/                   # 追加ログ
├── runs/                       # 実行ログ（run_id ごと）
├── settings.json               # Claude Code 設定
└── README.md
```

## 使い方

### 基本実行

```bash
# コマンドライン引数
cc "タスクの説明"

# ファイルから
cc -f task.txt

# パイプ入力
echo "タスクの説明" | cc

# 対話モード
cc
```

### 動作フロー

1. **Recall**: 過去のメモから関連情報を BM25 で検索
2. **Inject**: 検索結果をシステムプロンプトに注入
3. **Execute**: Claude Code を対話モードで実行
4. **Memoize**: 条件を満たす場合にメモを保存（緩い基準）

## メモ保存ルール

### 保存される条件

- 失敗時（exit_code != 0）は自動保存
- 成功時は以下のゲートを通過した場合のみ:
  - 1日の上限（デフォルト50件）を超えていない
  - ルールゲート: キーワードマッチ（チェックリスト、原因、判断基準など）
  - LLMジャッジ: 緩い基準で worthy=true と判定（迷ったら保存）

### 良いメモの基準（緩め）

- 何か新しいことを学んだ/発見した
- エラーを解決した
- 設定やツールの使い方を確認した
- コードの書き方・パターンを試した

### 保存禁止

- APIキー / トークン / Cookie / JWT（機密情報）
- 単純な typo 修正のみ
- 会話だけで実作業なし
- 1回の実行で複数メモ

## 環境変数

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| `CLAUDE_CMD` | `claude` | Claude Code CLI のコマンド名 |
| `CC_TOPK` | `5` | Recall 時の取得件数 |
| `CC_LOG_TAIL` | `200` | メモ生成時に参照するログ行数 |
| `CC_MEMO_DAILY_CAP` | `50` | 成功時メモの1日上限 |
| `CC_MEMO_JUDGE` | `1` | LLMジャッジの有効/無効 |
| `CC_MEMO_RULE_GATE` | `1` | ルールゲートの有効/無効 |
| `CC_MEMO_ON_SUCCESS` | `0` | 成功時も常にメモ保存 |
| `CC_ENABLE_GIT_DIFF` | `1` | git diff を検索クエリに含める |
| `CC_MAX_FIELD_CHARS` | `800` | フィールドの最大文字数 |

## 依存関係

- `sqlite3`
- `python3`
- `claude` (Claude Code CLI)

## データベーススキーマ

### memos テーブル

メモの本体。FTS5 インデックス付き。

| カラム | 説明 |
|--------|------|
| id | 一意ID (timestamp) |
| ts | ISO8601 タイムスタンプ |
| project | リポジトリ名など |
| tags | カンマ区切りのタグ |
| problem | 何が起きたか |
| fix | 何をしたら解決したか |
| takeaway | 次回の判断基準 |
| context | 環境情報 |

## 日報機能（Daily Report）

### 概要

`history.jsonl` から当日のユーザー入力を抽出し、プロジェクト別・時系列で日報を生成する。

### 出力先

```
~/.claude/memory/daily/YYYY-MM-DD.md
```

### 日報の形式

```markdown
# 2026-01-21 日報

## 概要
- **プロジェクト数**: 3
- **タスク数**: 45
- **作業時間**: 09:00 〜 18:30 (570分)

## 成果サマリー

### project-name
- [09:15] 主要なタスク1
- [10:30] 主要なタスク2

## 詳細

### project-name
**時間**: 09:00 〜 12:00 (180分) | **タスク**: 15件

- [09:00] タスク内容1
- [09:15] タスク内容2
...
```

### 含まれる情報

- **概要**: プロジェクト数、セッション数、タスク数、編集ファイル数、コマンド実行数、作業時間
- **今日の学び**: memos.sqlite から当日の学びメモを抽出（問題・解決・教訓）
- **成果サマリー**: 各プロジェクトの編集ファイルと主要タスク
- **詳細（セッション別）**:
  - **成果**: Claude の返答から抽出した変更内容（before/after）
  - **タスク**: ユーザーが依頼した内容（タイムスタンプ付き）
  - **編集したファイル**: 変更されたファイル名
  - **実行したコマンド**: 説明 + コマンド + 実行結果

### フィルタリングルール

以下は日報から除外される:
- `[Pasted text ...]` 形式のペースト
- 150文字以上の入力
- 改行を含む入力
- 3文字以下の短い入力
- 英小文字のみの単語（コマンド名など）

### 自動実行

`settings.json` の SessionEnd hook により、Claude Code セッション終了時に自動実行される。

```json
{
  "hooks": {
    "SessionEnd": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "$HOME/.claude/bin/daily-report.sh"
          }
        ]
      }
    ]
  }
}
```

手動実行: `~/.claude/bin/daily-report.sh`

## ライセンス

Private
